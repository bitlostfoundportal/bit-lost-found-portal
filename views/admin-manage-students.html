<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Students (Admin) - BIT Lost & Found Portal</title>
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="stylesheet" href="/css/popup.css">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <h1>BIT Lost-Found Portal</h1>
            </div>
        </div>
    </header>

    <main class="container">
        <div id="message-area"></div>
        <div class="welcome-section" style="text-align: center;">
            <h2>Manage Registered Students</h2>
            <p>Welcome, <span id="adminName"></span> (<span id="adminEmail"></span>)!</p>
        </div>

        <div class="admin-nav">
            <a href="/admin">⬅ Back to Dashboard</a>
            <a href="/admin/add-student" class="add-btn">➕ Add New Student</a>
        </div>

        <section class="admin-section">
            <h3>Students</h3>
            <div class="search-bar-container">
                <input type="text" id="studentSearchInput" placeholder="Search by Roll No., Name, or Email">
                <button id="searchStudentsBtn">Search</button>
            </div>
            <div class="admin-table-container">
                <table id="allStudentsTable" class="admin-table">
                    <thead>
                        <tr>
                            <th class="short">ID</th>
                            <th>Roll No.</th>
                            <th>Name</th>
                            <th>Name from Database</th>
                            <th>Name from Email Login</th>
                            <th>Both Names Match</th>
                            <th class="email">College Email</th>
                            <th>Google ID</th>
                            <th class="actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Student data will be loaded here by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="pagination">
                <button id="prevPageBtn">Previous Page</button>
                <span id="pageInfo">Page 1 of 1</span>
                <button id="nextPageBtn">Next Page</button>
            </div>
        </section>

        <!-- Delete Confirmation Modal -->
        <div id="deleteModal" class="modal-overlay">
            <div class="modal-card">
                <h3>Confirm Deletion</h3>
                <p>Are you sure you want to permanently delete this <strong id="modalItemType"></strong>?</p>
                <div class="item-details">
                    <p><strong>ID:</strong> <span id="modalItemId"></span></p>
                    <p><strong>Name:</strong> <span id="modalItemName"></span></p>
                    <p><strong>Roll No.:</strong> <span id="modalItemStatus"></span></p>
                </div>
                <div class="button-group">
                    <button id="confirmDeleteBtn" class="delete-btn">Delete</button>
                    <button id="cancelDeleteBtn" class="cancel-btn">Cancel</button>
                </div>
            </div>
        </div>

    </main>

    <script src="/js/popup.js"></script>
    <script>
        let currentDeleteItem = null; // To store the ID and type of the item/student to be deleted
        let allStudentsData = []; // To store all students data for local filtering (now for current page)
        let currentPage = 1;
        const studentsPerPage = 100; // Fixed number of students per page
        let totalPages = 1;

        document.addEventListener('DOMContentLoaded', async () => {
            const messageArea = document.getElementById('message-area');
            const adminNameSpan = document.getElementById('adminName');
            const adminEmailSpan = document.getElementById('adminEmail');

            const deleteModal = document.getElementById('deleteModal');
            const modalItemType = document.getElementById('modalItemType');
            const modalItemId = document.getElementById('modalItemId');
            const modalItemName = document.getElementById('modalItemName');
            const modalItemStatus = document.getElementById('modalItemStatus');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');

            const studentSearchInput = document.getElementById('studentSearchInput');
            const searchStudentsBtn = document.getElementById('searchStudentsBtn');

            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const pageInfoSpan = document.getElementById('pageInfo');

            // Function to load students for the current page
            const loadStudents = async (page = 1, limit = studentsPerPage, searchTerm = '') => {
                try {
                    // Construct URL with pagination and search parameters
                    const url = new URL('/api/admin/students', window.location.origin);
                    url.searchParams.append('page', page);
                    url.searchParams.append('limit', limit);
                    if (searchTerm) {
                        // Note: Current backend /api/admin/students does not support searchTerm. 
                        // This would require backend modification if server-side filtering is desired.
                        // For now, search is frontend-only on the fetched page data.
                        url.searchParams.append('searchTerm', searchTerm);
                    }

                    const response = await fetch(url.toString());
                    const data = await response.json();

                    if (data.error) {
                        showPopup(data.error, 'error');
                        return;
                    }
                    
                    allStudentsData = data.students; // Store students for current page
                    currentPage = data.currentPage;
                    totalPages = data.totalPages;

                    renderStudents(allStudentsData); // Render students for the current page
                    updatePaginationControls();

                } catch (error) {
                    console.error('Error fetching students:', error);
                    showPopup('Error loading student data.', 'error');
                }
            };

            // Function to render students into the table
            const renderStudents = (studentsToRender) => {
                const tableBody = document.querySelector('#allStudentsTable tbody');
                tableBody.innerHTML = ''; // Clear existing rows

                if (studentsToRender.length === 0) {
                    const row = tableBody.insertRow();
                    row.innerHTML = `<td colspan="6" style="text-align: center;">No students found.</td>`;
                    return;
                }

                studentsToRender.forEach(student => {
                    const row = tableBody.insertRow();
                    row.id = `student-row-${student._id}`; // Add unique ID to row
                    row.innerHTML = `
                        <td class="short">${student._id}</td>
                        <td>${student.rollno}</td>
                        <td>${student.name}</td>
                        <td>${student.name || 'N/A'}</td>
                        <td>${student.google_display_name || 'N/A'}</td>
                        <td>${student.names_match ? '✅ Yes' : '❌ No'}</td>
                        <td class="email">${student.college_email || 'N/A'}</td>
                        <td>${student.googleId || 'N/A'}</td>
                        <td class="actions">
                            <button class="admin-action-btn edit" data-id="${student._id}" data-type="student">Edit</button>
                            <button class="admin-action-btn delete" data-id="${student._id}" data-type="student">Delete</button>
                        </td>
                    `;
                });
            };

            // Update pagination control states
            const updatePaginationControls = () => {
                pageInfoSpan.textContent = `Page ${currentPage} of ${totalPages}`;
                prevPageBtn.disabled = currentPage === 1;
                nextPageBtn.disabled = currentPage === totalPages;
            };

            // Initial load of students for the first page
            loadStudents(currentPage);

            // Event listener for student search
            searchStudentsBtn.addEventListener('click', () => {
                currentPage = 1; // Reset to first page for new search
                loadStudents(currentPage, studentsPerPage, studentSearchInput.value);
            });
            studentSearchInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') {
                    currentPage = 1; // Reset to first page for new search
                    loadStudents(currentPage, studentsPerPage, studentSearchInput.value);
                }
            });

            // Pagination event listeners
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadStudents(currentPage, studentsPerPage, studentSearchInput.value);
                }
            });

            nextPageBtn.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    loadStudents(currentPage, studentsPerPage, studentSearchInput.value);
                }
            });

            // Fetch user info for admin dashboard (already exists, keep it)
            try {
                const userRes = await fetch('/api/user');
                const userData = await userRes.json();

                if (userData.error) {
                    showPopup(userData.error, 'error');
                    return;
                }
                adminNameSpan.textContent = userData.name;
                adminEmailSpan.textContent = userData.rollno; // Display rollno as the unique identifier

            } catch (error) {
                console.error('Error fetching admin user data:', error);
                showPopup('Error loading admin data.', 'error');
            }

            // Add event listeners for action buttons (Edit/Delete) - delegated to tbody
            document.querySelector('#allStudentsTable tbody').addEventListener('click', handleAdminActions);

            // Centralized handler for admin actions (for students)
            async function handleAdminActions(event) {
                const target = event.target;
                const id = target.dataset.id;
                const type = target.dataset.type;

                if (target.classList.contains('edit')) {
                    if (type === 'student') {
                        window.location.href = `/admin/edit-student/${id}`; // Redirect to admin student edit page
                    } else if (type === 'item') {
                        // This branch should not be reached on this page
                        window.location.href = `/admin/edit-item/${id}`;
                    }
                } else if (target.classList.contains('delete')) {
                    currentDeleteItem = { id: id, type: type }; // Store ID and type

                    // Fetch details for the modal based on type
                    try {
                        let endpoint = '';
                        if (type === 'item') {
                            // This branch should not be reached on this page
                            endpoint = `/api/admin/item/${id}/data`;
                        } else if (type === 'student') {
                            endpoint = `/api/admin/student/${id}/data`;
                        }

                        const response = await fetch(endpoint);
                        const details = await response.json();

                        if (details.error) {
                            showPopup(details.error, 'error');
                            return;
                        }

                        modalItemType.textContent = 'student';
                        modalItemId.textContent = details._id;
                        modalItemName.textContent = details.name;
                        modalItemStatus.textContent = details.rollno;
                        deleteModal.classList.add('visible'); // Show the modal

                    } catch (error) {
                        console.error('Error fetching student details for modal:', error);
                        showPopup('Failed to load student details for deletion.', 'error');
                    }
                }
            }

            // Handle confirm deletion from modal
            confirmDeleteBtn.addEventListener('click', async () => {
                if (!currentDeleteItem) return; 

                confirmDeleteBtn.disabled = true; // Disable button to prevent double-click
                confirmDeleteBtn.textContent = 'Deleting...'; // Provide feedback

                let deleteEndpoint = '';
                if (currentDeleteItem.type === 'item') {
                    // This branch should not be reached on this page
                    deleteEndpoint = `/api/admin/item/${currentDeleteItem.id}`;
                } else if (currentDeleteItem.type === 'student') {
                    deleteEndpoint = `/api/admin/student/${currentDeleteItem.id}`;
                }

                try {
                    const response = await fetch(deleteEndpoint, {
                        method: 'DELETE',
                    });
                    const result = await response.json();
                    showPopup(result.message, response.ok ? 'success' : 'error');

                    if (response.ok) {
                        deleteModal.classList.remove('visible'); // Hide modal
                        // Directly remove the row from DOM for faster perceived update
                        const rowToRemove = document.getElementById(`student-row-${currentDeleteItem.id}`); // Use the unique ID
                        if (rowToRemove) {
                            rowToRemove.remove();
                        }
                        // After deleting, reload students to update pagination if necessary
                        loadStudents(currentPage, studentsPerPage, studentSearchInput.value); 
                    } else {
                        // If deletion failed, re-enable button
                        confirmDeleteBtn.disabled = false;
                        confirmDeleteBtn.textContent = 'Delete';
                    }
                } catch (err) {
                    console.error('Error during student deletion:', err);
                    showPopup("⚠️ Error deleting student: " + err.message, "error");
                    confirmDeleteBtn.disabled = false; // Re-enable button on error
                    confirmDeleteBtn.textContent = 'Delete';
                }
                currentDeleteItem = null; // Clear after attempt
            });

            // Handle cancel deletion from modal or overlay click
            cancelDeleteBtn.addEventListener('click', () => {
                deleteModal.classList.remove('visible');
                currentDeleteItem = null; // Clear the stored ID
                confirmDeleteBtn.disabled = false; // Re-enable button
                confirmDeleteBtn.textContent = 'Delete'; // Reset button text
            });
            deleteModal.addEventListener('click', (event) => {
                if (event.target === deleteModal) {
                    deleteModal.classList.remove('visible');
                    currentDeleteItem = null;
                    confirmDeleteBtn.disabled = false; // Re-enable button
                    confirmDeleteBtn.textContent = 'Delete'; // Reset button text
                }
            });

        });

        // Function to parse URL parameters and display messages
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const msg = urlParams.get('msg');
            const type = urlParams.get('type');

            if (msg && type) {
                showPopup(decodeURIComponent(msg), type);
                // history.replaceState(null, '', window.location.pathname);
            }
        });
    </script>
</body>
</html>
